rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ヘルパー関数
    function isAuthenticated() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    // ========================================
    // 弱点分析システム
    // ========================================

    // 単元マスタ（固定マスタデータ：読み取りは誰でも可、書き込みは認証済みユーザーのみ）
    match /masterUnits/{unitId} {
      allow read: if true;
      allow write: if isAuthenticated();
    }

    // 過去問マスタ（全員読み取り可、書き込み不可）
    match /problems/{problemId} {
      allow read: if isAuthenticated();
      allow write: if false; // 管理者のみ
    }

    // 問題-単元 中間テーブル（全員読み取り可、書き込み不可）
    match /problemUnitTags/{id} {
      allow read: if isAuthenticated();
      allow write: if false; // 管理者のみ
    }

    // 解答履歴（自分のみ読み書き可）
    match /answerHistory/{id} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // ユーザー弱点スコア（自分のみ読み書き可）
    match /userWeaknessScores/{id} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update: if isAuthenticated() && isOwner(resource.data.userId);
      allow delete: if false; // 削除は不可
    }

    // レコメンド履歴（自分のみ読み書き可）
    match /recommendationHistory/{id} {
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      allow create: if isAuthenticated() && isOwner(request.resource.data.userId);
      allow update, delete: if isAuthenticated() && isOwner(resource.data.userId);
    }

    // ========================================
    // 既存システム
    // ========================================

    // ユーザーデータへのアクセス制御
    match /users/{userId} {
      // ユーザー自身のドキュメントは読み書き可能
      allow read, write: if isAuthenticated() && isOwner(userId);

      // タスクコレクション
      match /tasks/{taskId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // カスタム単元コレクション
      match /customUnits/{unitId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // 過去問セッションコレクション
      match /pastPaperSessions/{sessionId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // テスト成績コレクション
      match /testScores/{scoreId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // 志望校詳細コレクション
      match /targetSchoolsDetail/{schoolId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // PDFドキュメントコレクション
      match /pdfDocuments/{pdfId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // PDF問題記録コレクション
      match /pdfProblems/{problemId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // SAPIXテキストコレクション
      match /sapixTexts/{textId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // 学習履歴ログ（lessonLogs）コレクション
      match /lessonLogs/{logId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // マスター単元習熟度統計（masterUnitStats）コレクション
      match /masterUnitStats/{unitId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }

      // 問題ライブラリ（切り抜き問題）コレクション
      // テスト・過去問・教材から切り抜いた問題画像と記録を管理
      match /problems/{problemId} {
        allow read, write: if isAuthenticated() && isOwner(userId);
      }
    }

    // その他のすべてのドキュメントへのアクセスを拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
